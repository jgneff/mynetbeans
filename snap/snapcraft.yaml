# snapcraft.yaml - builds a Snap package of the Apache NetBeans IDE
# Copyright 2021-2022 John Neffenger
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: mynetbeans
title: My NetBeans
summary: Apache NetBeans IDE for the OpenJDK Snap
description: |
  Apache NetBeans is an integrated development environment (IDE)
  for Java, with extensions for other languages like PHP, JavaScript,
  HTML5, Groovy, C, and C++. Applications based on NetBeans, including
  the NetBeans IDE, can be extended by third party developers.

  This package provides NetBeans for Linux and uses the OpenJDK Snap
  package, if installed, when the JAVA_HOME environment variable is
  not set. Building this package downloads the NetBeans source code
  directly from the Apache Web site, verifies its SHA-512 hash value,
  and builds NetBeans from source using the Ubuntu Ant package.

  For more information, see the repository for this package on GitHub:

  https://github.com/jgneff/mynetbeans

  Java and OpenJDK are trademarks or registered trademarks of Oracle
  and/or its affiliates.

version: '13'
license: Apache-2.0

base: core20
grade: stable
confinement: classic

architectures:
- build-on: amd64
  run-on: all

apps:
  mynetbeans:
    command: bin/netbeans.sh

parts:
  bin:
    plugin: dump
    source: .
    source-type: local
    stage: [bin]

  netbeans:
    plugin: nil
    source: https://github.com/apache/netbeans.git
    source-type: git
    source-tag: $SNAPCRAFT_PROJECT_VERSION
    source-depth: 1
    build-attributes: [no-patchelf]
    build-packages: [default-jdk-headless]
    build-snaps: [ant]
    # See this file for the branch names and commits of each release:
    # https://github.com/apache/netbeans-jenkins-lib/blob/master/meta/netbeansrelease.json
    build-environment:
    - RELEASE_BRANCH: release130
    override-build: |
      # Gets the host and port from a proxy URL
      #   $1 = the proxy URL, such as "http://10.10.10.1:8222/"
      getproxy () {
          host=$(echo "$1" | sed -E 's|https?://([^:/]*):?[0-9]*/?|\1|')
          port=$(echo "$1" | sed -E 's|https?://[^:/]*:?([0-9]*)/?|\1|')
      }

      # Sets Java networking properties when using a proxy server
      proxies=""
      if [ -n "${http_proxy:-}" ]; then
          getproxy "$http_proxy"
          proxies="-Dhttp.proxyHost=$host -Dhttp.proxyPort=$port"
      fi
      if [ -n "${https_proxy:-}" ]; then
          getproxy "$https_proxy"
          proxies="$proxies -Dhttps.proxyHost=$host -Dhttps.proxyPort=$port"
      fi

      # Builds NetBeans
      export ANT_OPTS="$proxies"
      ant -Dmetabuild.branch="$RELEASE_BRANCH" -quiet
      rm -f nbbuild/netbeans/*.built
      chmod a+r nbbuild/netbeans/etc/netbeans.conf
      mv nbbuild/netbeans "$SNAPCRAFT_PART_INSTALL"

      # Prints Ant diagnostics report
      ant -diagnostics
